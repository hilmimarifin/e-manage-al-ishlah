// --- RBAC core (tidak berubah) ---

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  username  String   @unique
  password  String
  roleId    String
  role      Role     @relation(fields: [roleId], references: [id])
  classes   Class[]  @relation("TeacherClasses") // relasi guru ke kelas
  payments  Payment[] @relation("RecordedPayments") // pembayaran yang dicatat guru
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("users")
}

model Role {
  id          String     @id @default(cuid())
  name        String     @unique
  description String?
  users       User[]
  roleMenus   RoleMenu[]
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt

  @@map("roles")
}

model Menu {
  id          String     @id @default(cuid())
  name        String
  path        String     @unique
  icon        String?
  parentId    String?
  parent      Menu?      @relation("MenuHierarchy", fields: [parentId], references: [id])
  children    Menu[]     @relation("MenuHierarchy")
  orderIndex  Int        @default(0)
  roleMenus   RoleMenu[]
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt

  @@map("menus")
}

model RoleMenu {
  id        String  @id @default(cuid())
  roleId    String
  menuId    String
  canRead   Boolean @default(true)
  canWrite  Boolean @default(false)
  canUpdate Boolean @default(false)
  canDelete Boolean @default(false)
  role      Role    @relation(fields: [roleId], references: [id], onDelete: Cascade)
  menu      Menu    @relation(fields: [menuId], references: [id], onDelete: Cascade)

  @@unique([roleId, menuId])
  @@map("role_menus")
}

//
// --- Student Management System (MVP) ---
//

model Student {
  id          String     @id @default(cuid())
  fullName    String
  birthDate   DateTime?
  address     String?
  phone       String?
  guardian    String?     // wali murid
  classId     String?
  class       Class?      @relation(fields: [classId], references: [id])
  payments    Payment[]
  status      StudentStatus @default(ACTIVE)
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt

  @@map("students")
}

model Class {
  id        String    @id @default(cuid())
  name      String
  level     String?   // contoh: "Kelas 1", "Kelas 2"
  year      String?   // tahun ajaran
  capacity  Int?
  teacherId String?   // guru wali kelas
  teacher   User?     @relation("TeacherClasses", fields: [teacherId], references: [id])
  students  Student[]
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  @@map("classes")
}

model Payment {
  id          String   @id @default(cuid())
  studentId   String
  student     Student  @relation(fields: [studentId], references: [id], onDelete: Cascade)

  amount      Float
  month       Int      // 1-12
  year        Int
  status      PaymentStatus @default(PAID) // cash â†’ langsung tercatat sebagai PAID
  paidAt      DateTime      @default(now())

  // Guru yang mencatat pembayaran
  recordedBy  String
  teacher     User     @relation("RecordedPayments", fields: [recordedBy], references: [id])

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([studentId, month, year]) // 1 student hanya 1 payment per bulan
  @@map("payments")
}

//
// --- ENUMS ---
//

enum StudentStatus {
  ACTIVE
  INACTIVE
  GRADUATED
}

enum PaymentStatus {
  PENDING
  PAID
  OVERDUE
}
